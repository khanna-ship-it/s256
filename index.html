<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S256 Command Center</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
        }
        /* Color classes for ranks (kept for leaderboard tab) */
        .ranking-card:nth-child(2) { border-left: 5px solid #ffcc00; transform: scale(1.01); }
        .ranking-card:nth-child(3) { border-left: 5px solid #cccccc; }
        .ranking-card:nth-child(4) { border-left: 5px solid #cd7f32; }
        .rank-number { font-size: 1.5rem; font-weight: 700; }
        .ranking-card:nth-child(2) .rank-number { color: #ffcc00; }
        .ranking-card:nth-child(3) .rank-number { color: #cccccc; }
        .ranking-card:nth-child(4) .rank-number { color: #cd7f32; }

        .sortable-header { cursor: pointer; transition: color 0.15s; }
        .sortable-header:hover { color: #4f46e5; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Custom styles for migration status badges */
        .status-ready { background-color: #10b981; } /* Emerald-500 */
        .status-waiting { background-color: #f59e0b; } /* Amber-500 */
        .status-migrated { background-color: #3b82f6; } /* Blue-500 */
        .status-needed { background-color: #ef4444; } /* Red-500 */
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="max-w-6xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-5xl font-extrabold text-white mb-2 tracking-wider">S256 Command Center</h1>
            <p class="text-lg text-gray-400">The central hub for Server 256 metrics and information.</p>
            <p id="auth-status" class="text-sm text-gray-500 mt-2"></p>
        </header>

        <!-- Tab Navigation -->
        <nav class="flex justify-center border-b border-gray-700 mb-8">
            <button class="tab-button py-3 px-6 text-sm font-medium text-gray-400 hover:text-white hover:bg-[#1e232b] border-b-2 border-transparent transition duration-150 active-tab" 
                    data-tab="leaderboard">256 Rankings</button>
            <button class="tab-button py-3 px-6 text-sm font-medium text-gray-400 hover:text-white hover:bg-[#1e232b] border-b-2 border-transparent transition duration-150" 
                    data-tab="submit">Submit Rank</button>
            <!-- UPDATED TAB NAME -->
            <button class="tab-button py-3 px-6 text-sm font-medium text-gray-400 hover:text-white hover:bg-[#1e232b] border-b-2 border-transparent transition duration-150" 
                    data-tab="info">Migration Status</button>
            <button class="tab-button py-3 px-6 text-sm font-medium text-gray-400 hover:text-white hover:bg-[#1e232b] border-b-2 border-transparent transition duration-150" 
                    data-tab="guides">Guides</button>
            <button class="tab-button py-3 px-6 text-sm font-medium text-gray-400 hover:text-white hover:bg-[#1e232b] border-b-2 border-transparent transition duration-150" 
                    data-tab="resources">Resources</button>
        </nav>


        <!-- Tab Content Containers -->

        <!-- 1. 256 Rankings Tab (Leaderboard) -->
        <div id="leaderboard" class="tab-content active">
            <!-- Loading Indicator -->
            <div id="loading" class="text-center text-white p-10 hidden">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-t-4 border-blue-500 border-gray-800 rounded-full"></div>
                <p class="mt-2">Loading server rankings...</p>
            </div>

            <!-- Leaderboard Content -->
            <div id="main-content" class="max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold text-white mb-4 border-b border-gray-700 pb-2">256 Player Rankings</h2>
                
                <!-- Search/Filter Bar -->
                <div class="mb-4">
                    <input type="text" id="search-input" placeholder="Filter by Player Name or Alliance..."
                           class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Ranking List Header (Sortable) -->
                <div id="ranking-header" class="flex items-center p-3 bg-[#1e232b] rounded-t-lg text-gray-400 font-semibold text-sm border-b border-gray-700">
                    <div class="w-10 text-center mr-4">#</div>
                    <div class="flex-grow">Player / Alliance</div>
                    <div id="sort-power" data-sort-key="power" class="sortable-header flex-shrink-0 text-right ml-4 w-24 hidden md:block">
                        Power
                        <span id="power-sort-icon" class="text-blue-500 text-xs ml-1">â–²</span>
                    </div>
                    <div id="sort-kills" data-sort-key="kill_count" class="sortable-header flex-shrink-0 text-right ml-6 w-24">
                        Kills
                        <span id="kills-sort-icon" class="text-gray-500 text-xs ml-1"></span>
                    </div>
                    <div id="sort-merits" data-sort-key="merit_count" class="sortable-header flex-shrink-0 text-right ml-6 w-24">
                        Merits
                        <span id="merits-sort-icon" class="text-gray-500 text-xs ml-1"></span>
                    </div>
                    <div class="flex-shrink-0 text-right ml-6 hidden md:block w-24">Updated</div>
                </div>

                <div id="ranking-list" class="space-y-1">
                    <!-- Rankings will be injected here -->
                    <p class="text-gray-500 text-center py-10" id="empty-state">No rankings yet. Use the Submit Rank tab to add some!</p>
                </div>
            </div>
        </div>

        <!-- 2. Submit Rank Tab (Form) -->
        <div id="submit" class="tab-content">
            <div class="max-w-lg mx-auto bg-[#161b22] p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-3xl font-bold text-white mb-4">Submit / Update Your Rank</h2>

                <form id="ranking-form" class="space-y-4">
                    <div>
                        <label for="playerName" class="block text-sm font-medium text-gray-300">Player Name</label>
                        <input type="text" id="playerName" required placeholder="GamerTag (Case-sensitive for display)"
                               class="mt-1 block w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="allianceTag" class="block text-sm font-medium text-gray-300">Alliance Tag (e.g., [XYZ])</label>
                        <input type="text" id="allianceTag" placeholder="e.g., [S256]"
                               class="mt-1 block w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="powerLevel" class="block text-sm font-medium text-gray-300">Power Level</label>
                        <input type="number" id="powerLevel" required placeholder="e.g., 1,500,000"
                               class="mt-1 block w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="killCount" class="block text-sm font-medium text-gray-300">Kill Count</label>
                        <input type="number" id="killCount" required placeholder="e.g., 10,500"
                               class="mt-1 block w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <!-- NEW MERIT COUNT FIELD -->
                    <div>
                        <label for="meritCount" class="block text-sm font-medium text-gray-300">Total Merits</label>
                        <input type="number" id="meritCount" required placeholder="e.g., 50,000"
                               class="mt-1 block w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="submit" id="submitBtn"
                            class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                        Submit Rank
                    </button>
                </form>

                <div id="message-box" class="mt-4 p-3 rounded-md text-sm text-center hidden"></div>
            </div>
        </div>

        <!-- 3. Migration Status Tab (New Content) -->
        <div id="info" class="tab-content">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Migration Status Tracking</h2>

                <!-- ADD/EDIT FORM -->
                <div class="bg-[#161b22] p-6 rounded-xl shadow-lg border border-gray-700 mb-6">
                    <h3 class="text-xl font-semibold text-white mb-4" id="migration-form-title">Add New Migration Entry</h3>
                    <form id="migration-form" class="space-y-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <input type="hidden" id="migrationId">
                        <div>
                            <label for="migratorName" class="block text-sm font-medium text-gray-300">Player Name</label>
                            <input type="text" id="migratorName" required placeholder="Player Name"
                                class="mt-1 block w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="targetKingdom" class="block text-sm font-medium text-gray-300">Target Kingdom (e.g., S206)</label>
                            <input type="text" id="targetKingdom" required placeholder="e.g., S206"
                                class="mt-1 block w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="ticketsUsed" class="block text-sm font-medium text-gray-300">Tickets Used</label>
                            <input type="number" id="ticketsUsed" required value="0"
                                class="mt-1 block w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="migrationStatus" class="block text-sm font-medium text-gray-300">Status</label>
                            <select id="migrationStatus" required 
                                class="mt-1 block w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-blue-500 focus:border-blue-500">
                                <option value="Ready" class="status-ready text-white">Ready to Migrate (Tickets)</option>
                                <option value="Waiting" class="status-waiting text-white">Waiting for Ticket</option>
                                <option value="Migrated" class="status-migrated text-white">Migrated</option>
                                <option value="Needed" class="status-needed text-white">Needs More Tickets</option>
                            </select>
                        </div>
                        <button type="submit" id="migrationSubmitBtn"
                                class="md:col-span-2 lg:col-span-4 w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                            Save Migration Entry
                        </button>
                    </form>
                    <button id="migrationClearBtn" class="mt-2 w-full py-1 text-sm text-gray-400 hover:text-white" style="display:none;">
                        Clear Form / Cancel Edit
                    </button>
                    <div id="migration-message-box" class="mt-4 p-3 rounded-md text-sm text-center hidden"></div>
                </div>

                <!-- MIGRATION LIST -->
                <div class="bg-[#161b22] p-6 rounded-xl shadow-lg border border-gray-700">
                    <h3 class="text-xl font-semibold text-white mb-4">Current Migration Tracking</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-800">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/4">Player</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Target</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Tickets</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="migration-list" class="bg-[#161b22] divide-y divide-gray-700">
                                <!-- Migration entries will be injected here -->
                                <tr><td colspan="5" class="text-center py-4 text-gray-500" id="migration-empty-state">No migration entries tracked.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. Guides Tab (Placeholder) -->
        <div id="guides" class="tab-content">
            <div class="max-w-4xl mx-auto bg-[#161b22] p-6 rounded-xl shadow-lg border border-gray-700 text-white text-center">
                <h2 class="text-3xl font-bold mb-4">Guides & Tutorials</h2>
                <p class="text-gray-400">Content coming soon! This tab will host community-created guides for optimizing power, maximizing kills, and event strategies.</p>
            </div>
        </div>

        <!-- 5. Resources Tab (Placeholder) -->
        <div id="resources" class="tab-content">
            <div class="max-w-4xl mx-auto bg-[#161b22] p-6 rounded-xl shadow-lg border border-gray-700 text-white text-center">
                <h2 class="text-3xl font-bold mb-4">External Resources</h2>
                <p class="text-gray-400">Content coming soon! This tab will link to important Discord channels, alliance planning documents, and external game tools.</p>
            </div>
        </div>

    </div>

    <!-- Firebase Configuration and Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, setDoc, doc, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        // =========================================================================
        // STEP 1: Firebase Configuration Setup
        // =========================================================================

        const firebaseConfig = {
            apiKey: "AIzaSyDPBsLGnZSy9gl0J-Toy97sx04sbMliN1A",
            authDomain: "aoem-s256.firebaseapp.com",
            projectId: "aoem-s256",
            storageBucket: "aoem-s256.firebasestorage.app",
            messagingSenderId: "841512392095",
            appId: "1:841512392095:web:84df8ffedacb97352859aa",
            measurementId: "G-N6GB8LBHWJ"
        };

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId; 
        
        // =========================================================================
        
        // UI Elements
        const loadingEl = document.getElementById('loading');
        const rankingListEl = document.getElementById('ranking-list');
        const emptyStateEl = document.getElementById('empty-state');
        const authStatusEl = document.getElementById('auth-status');
        const formEl = document.getElementById('ranking-form');
        const messageBoxEl = document.getElementById('message-box');
        const submitBtn = document.getElementById('submitBtn');
        const searchInputEl = document.getElementById('search-input');
        
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // Migration UI Elements
        const migrationFormEl = document.getElementById('migration-form');
        const migrationListEl = document.getElementById('migration-list');
        const migrationMessageBoxEl = document.getElementById('migration-message-box');
        const migrationEmptyStateEl = document.getElementById('migration-empty-state');
        const migrationSubmitBtn = document.getElementById('migrationSubmitBtn');
        const migrationClearBtn = document.getElementById('migrationClearBtn');
        const migrationFormTitleEl = document.getElementById('migration-form-title');

        // Sorting elements (Leaderboard)
        const sortPowerEl = document.getElementById('sort-power');
        const sortKillsEl = document.getElementById('sort-kills');
        const sortMeritsEl = document.getElementById('sort-merits');
        const powerSortIconEl = document.getElementById('power-sort-icon');
        const killsSortIconEl = document.getElementById('kills-sort-icon');
        const meritsSortIconEl = document.getElementById('merits-sort-icon');

        // Firebase instances
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        
        // Collection Names
        const RANKING_COLLECTION_NAME = 'server256_rankings'; 
        const MIGRATION_COLLECTION_NAME = 'migration_status';

        // Global state for rankings and sorting
        let allRankings = [];
        let sortState = {
            key: 'power', 
            direction: 'desc'
        };
        
        /**
         * Switches the active tab content.
         * @param {string} tabId The ID of the tab content to show (e.g., 'leaderboard').
         */
        function switchTab(tabId) {
            tabContents.forEach(content => {
                content.classList.remove('active');
            });

            tabButtons.forEach(button => {
                button.classList.remove('text-white', 'bg-[#1e232b]');
                button.classList.add('text-gray-400', 'hover:text-white');
                button.style.borderBottomColor = 'transparent';
            });

            const activeContent = document.getElementById(tabId);
            if (activeContent) {
                activeContent.classList.add('active');
                // Special case: Load migration data when tab is opened
                if (tabId === 'info' && isAuthReady) {
                    loadMigrationStatus();
                }
            }

            const activeButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            if (activeButton) {
                activeButton.classList.add('text-white', 'bg-[#1e232b]');
                activeButton.classList.remove('text-gray-400', 'hover:text-white');
                activeButton.style.borderBottomColor = '#4f46e5';
            }
        }
        
        // Initialize default tab to Leaderboard
        switchTab('leaderboard'); 
        
        // Add listeners for tab buttons
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        /**
         * Shows a temporary message in the generic message box (used by Leaderboard form).
         * @param {string} message The message to display.
         * @param {boolean} isError True for error style, false for success/info style.
         */
        function showMessage(message, isError = false) {
            messageBoxEl.textContent = message;
            messageBoxEl.classList.remove('hidden', 'bg-red-900', 'text-red-300', 'bg-green-900', 'text-green-300');
            if (isError) {
                messageBoxEl.classList.add('bg-red-900', 'text-red-300');
            } else {
                messageBoxEl.classList.add('bg-green-900', 'text-green-300');
            }
            setTimeout(() => {
                messageBoxEl.classList.add('hidden');
            }, 5000);
        }

        /**
         * Shows a temporary message in the migration message box.
         * @param {string} message The message to display.
         * @param {boolean} isError True for error style, false for success/info style.
         */
        function showMigrationMessage(message, isError = false) {
            migrationMessageBoxEl.textContent = message;
            migrationMessageBoxEl.classList.remove('hidden', 'bg-red-900', 'text-red-300', 'bg-green-900', 'text-green-300');
            if (isError) {
                migrationMessageBoxEl.classList.add('bg-red-900', 'text-red-300');
            } else {
                migrationMessageBoxEl.classList.add('bg-green-900', 'text-green-300');
            }
            setTimeout(() => {
                migrationMessageBoxEl.classList.add('hidden');
            }, 5000);
        }

        // =========================================================================
        // LEADERBOARD LOGIC (Existing)
        // =========================================================================

        function applyFiltersAndSort() {
            let filteredRankings = [...allRankings];
            const filterTerm = searchInputEl.value.toLowerCase().trim();

            if (filterTerm) {
                filteredRankings = filteredRankings.filter(player =>
                    player.name.toLowerCase().includes(filterTerm) ||
                    (player.alliance && player.alliance.toLowerCase().includes(filterTerm))
                );
            }

            filteredRankings.sort((a, b) => {
                const aVal = a[sortState.key] || 0;
                const bVal = b[sortState.key] || 0;

                let comparison = 0;
                if (aVal > bVal) comparison = 1;
                else if (aVal < bVal) comparison = -1;

                return sortState.direction === 'asc' ? comparison : comparison * -1;
            });

            renderRankings(filteredRankings);
        }

        function renderRankings(rankings) {
            const filterTerm = searchInputEl.value.toLowerCase().trim();
            
            const updateSortIcon = (key, iconEl) => {
                iconEl.textContent = sortState.key === key ? (sortState.direction === 'desc' ? 'â–¼' : 'â–²') : '';
                iconEl.classList.toggle('text-blue-500', sortState.key === key);
                iconEl.classList.toggle('text-gray-500', sortState.key !== key);
            };

            updateSortIcon('power', powerSortIconEl);
            updateSortIcon('kill_count', killsSortIconEl);
            updateSortIcon('merit_count', meritsSortIconEl);

            if (rankings.length === 0) {
                emptyStateEl.textContent = filterTerm ? "No players match the search criteria." : "No rankings yet. Use the Submit Rank tab to add some!";
                emptyStateEl.classList.remove('hidden');
                rankingListEl.innerHTML = '';
                return;
            }

            emptyStateEl.classList.add('hidden');
            const html = rankings.map((player, index) => {
                const rank = index + 1;
                const formattedPower = (player.power || 0).toLocaleString();
                const formattedKills = (player.kill_count || 0).toLocaleString();
                const formattedMerits = (player.merit_count || 0).toLocaleString(); 
                const allianceTag = player.alliance || '[N/A]';
                const lastUpdated = player.last_updated && typeof player.last_updated.toDate === 'function' ? player.last_updated.toDate().toLocaleDateString() : 'N/A';

                return `
                    <div class="ranking-card flex items-center p-4 bg-[#1e232b] rounded-lg shadow-xl hover:bg-[#252a32] transition duration-200 ease-in-out">
                        <!-- Rank Number -->
                        <div class="rank-number w-10 text-center mr-4 text-white">#${rank}</div>

                        <!-- Player Info -->
                        <div class="flex-grow">
                            <h3 class="text-xl font-semibold text-white truncate">${player.name}</h3>
                            <p class="text-sm text-gray-400 font-mono">${allianceTag}</p>
                        </div>

                        <!-- Power Stats -->
                        <div class="flex-shrink-0 text-right ml-4 w-24 hidden md:block">
                            <p class="text-lg font-bold text-yellow-400">${formattedPower}</p>
                            <p class="text-xs text-gray-500">Power</p>
                        </div>
                        
                        <!-- Kills Stats -->
                        <div class="flex-shrink-0 text-right ml-6 w-24">
                            <p class="text-lg font-bold text-red-400">${formattedKills}</p>
                            <p class="text-xs text-gray-500">Kills</p>
                        </div>

                        <!-- Merits Stats -->
                        <div class="flex-shrink-0 text-right ml-6 w-24">
                            <p class="text-lg font-bold text-green-400">${formattedMerits}</p>
                            <p class="text-xs text-gray-500">Merits</p>
                        </div>

                        <!-- Last Updated -->
                        <div class="flex-shrink-0 text-right ml-6 hidden md:block w-24">
                            <p class="text-sm text-gray-300">${lastUpdated}</p>
                            <p class="text-xs text-gray-500">Updated</p>
                        </div>
                    </div>
                `;
            }).join('');

            rankingListEl.innerHTML = html;
        }

        // Leaderboard Submission (already private)
        formEl.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAuthReady || !db || !userId) {
                showMessage("Authentication not complete. Please wait.", true);
                return;
            }

            submitBtn.textContent = "Saving...";
            submitBtn.disabled = true;

            const name = document.getElementById('playerName').value.trim();
            const alliance = document.getElementById('allianceTag').value.trim();
            const power = parseInt(document.getElementById('powerLevel').value, 10);
            const kill_count = parseInt(document.getElementById('killCount').value, 10);
            const merit_count = parseInt(document.getElementById('meritCount').value, 10); 

            if (!name || isNaN(power) || isNaN(kill_count) || isNaN(merit_count)) {
                showMessage("Please ensure Player Name, Power Level, Kill Count, and Total Merits are correctly filled.", true);
                submitBtn.textContent = "Submit Rank";
                submitBtn.disabled = false;
                return;
            }

            const docId = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
            const rankDocRef = doc(db, `artifacts/${appId}/users/${userId}/${RANKING_COLLECTION_NAME}`, docId);

            const newRanking = {
                name: name,
                alliance: alliance,
                power: power,
                kill_count: kill_count,
                merit_count: merit_count, 
                ownerId: userId,
                last_updated: Timestamp.now()
            };

            try {
                await setDoc(rankDocRef, newRanking);
                showMessage(`Ranking for ${name} submitted/updated successfully!`, false);
                formEl.reset();
            } catch (error) {
                console.error("Error submitting ranking:", error);
                showMessage(`Failed to submit ranking: ${error.message}`, true);
            } finally {
                submitBtn.textContent = "Submit Rank";
                submitBtn.disabled = false;
            }
        });

        // Leaderboard Sorting/Filtering Listeners
        searchInputEl.addEventListener('input', applyFiltersAndSort);

        const handleSortClick = (event) => {
            const newKey = event.currentTarget.dataset.sortKey;

            if (sortState.key === newKey) {
                sortState.direction = sortState.direction === 'desc' ? 'asc' : 'desc';
            } else {
                sortState.key = newKey;
                sortState.direction = 'desc';
            }

            applyFiltersAndSort();
        };

        sortPowerEl.addEventListener('click', handleSortClick);
        sortKillsEl.addEventListener('click', handleSortClick);
        sortMeritsEl.addEventListener('click', handleSortClick);


        // =========================================================================
        // MIGRATION STATUS LOGIC (NEW)
        // =========================================================================

        /**
         * Renders the list of migration entries.
         * @param {Array<Object>} entries Array of migration objects.
         */
        function renderMigrationStatus(entries) {
            migrationListEl.innerHTML = ''; // Clear previous entries
            
            if (entries.length === 0) {
                migrationListEl.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No migration entries tracked.</td></tr>`;
                return;
            }

            const html = entries.map(entry => {
                let statusClass = '';
                switch(entry.status) {
                    case 'Ready': statusClass = 'status-ready'; break;
                    case 'Waiting': statusClass = 'status-waiting'; break;
                    case 'Migrated': statusClass = 'status-migrated'; break;
                    case 'Needed': statusClass = 'status-needed'; break;
                    default: statusClass = 'bg-gray-500'; // Default color
                }

                return `
                    <tr class="hover:bg-gray-800 transition duration-100 ease-in-out">
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-white">${entry.name}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-300">${entry.target}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-right font-mono text-yellow-400">${entry.tickets}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-center">
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full text-white ${statusClass}">
                                ${entry.status}
                            </span>
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button data-id="${entry.id}" class="edit-btn text-blue-400 hover:text-blue-200">Edit</button>
                            <button data-id="${entry.id}" class="delete-btn text-red-400 hover:text-red-200">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');

            migrationListEl.innerHTML = html;

            // Attach event listeners for edit and delete buttons
            migrationListEl.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => editMigrationEntry(e.currentTarget.dataset.id, entries));
            });
            migrationListEl.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => deleteMigrationEntry(e.currentTarget.dataset.id));
            });
        }
        
        /**
         * Sets up the real-time listener for migration status data (private collection).
         */
        function loadMigrationStatus() {
            if (!isAuthReady || !db || !userId) {
                console.log("Waiting for authentication to load migration status.");
                return;
            }

            const migrationRef = collection(db, `artifacts/${appId}/users/${userId}/${MIGRATION_COLLECTION_NAME}`);
            const q = query(migrationRef);

            onSnapshot(q, (snapshot) => {
                const migrationEntries = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // Sort by target kingdom for stable view
                migrationEntries.sort((a, b) => a.target.localeCompare(b.target)); 
                
                renderMigrationStatus(migrationEntries);
                console.log("Migration entries updated in real-time:", migrationEntries.length);
            }, (error) => {
                console.error("Error fetching migration status:", error);
                showMigrationMessage(`Error fetching migration data: ${error.message}`, true);
            });
        }

        /**
         * Handles submission (add or update) of migration status form.
         */
        migrationFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAuthReady || !db || !userId) {
                showMigrationMessage("Authentication not complete. Please wait.", true);
                return;
            }

            migrationSubmitBtn.textContent = "Saving...";
            migrationSubmitBtn.disabled = true;

            const form = e.target;
            const docId = form.elements.migrationId.value.trim() || form.elements.migratorName.value.toLowerCase().replace(/[^a-z0-9]/g, '_');
            const name = form.elements.migratorName.value.trim();
            const target = form.elements.targetKingdom.value.trim();
            const tickets = parseInt(form.elements.ticketsUsed.value, 10);
            const status = form.elements.migrationStatus.value;

            if (!name || !target || isNaN(tickets) || !status) {
                showMigrationMessage("Please fill out all migration fields correctly.", true);
                migrationSubmitBtn.textContent = "Save Migration Entry";
                migrationSubmitBtn.disabled = false;
                return;
            }
            
            const migrationDocRef = doc(db, `artifacts/${appId}/users/${userId}/${MIGRATION_COLLECTION_NAME}`, docId);

            const entryData = {
                name: name,
                target: target,
                tickets: tickets,
                status: status,
                last_updated: Timestamp.now()
            };

            try {
                await setDoc(migrationDocRef, entryData);
                showMigrationMessage(`${name}'s migration status saved successfully!`, false);
                // Clear the form back to 'Add New' state
                clearMigrationForm();
            } catch (error) {
                console.error("Error submitting migration status:", error);
                showMigrationMessage(`Failed to save migration status: ${error.message}`, true);
            } finally {
                migrationSubmitBtn.textContent = "Save Migration Entry";
                migrationSubmitBtn.disabled = false;
            }
        });
        
        /**
         * Loads an existing entry into the form for editing.
         */
        function editMigrationEntry(id, entries) {
            const entry = entries.find(e => e.id === id);
            if (!entry) return;
            
            document.getElementById('migrationId').value = entry.id;
            document.getElementById('migratorName').value = entry.name;
            document.getElementById('targetKingdom').value = entry.target;
            document.getElementById('ticketsUsed').value = entry.tickets;
            document.getElementById('migrationStatus').value = entry.status;

            // Change button/title to reflect editing
            migrationFormTitleEl.textContent = `Editing: ${entry.name}`;
            migrationSubmitBtn.textContent = 'Update Entry';
            migrationClearBtn.style.display = 'block';
        }

        /**
         * Deletes a migration entry.
         * @param {string} id The document ID to delete.
         */
        async function deleteMigrationEntry(id) {
            if (!confirm(`Are you sure you want to delete this migration entry?`)) return;

            try {
                const migrationDocRef = doc(db, `artifacts/${appId}/users/${userId}/${MIGRATION_COLLECTION_NAME}`, id);
                await deleteDoc(migrationDocRef);
                showMigrationMessage('Entry deleted successfully.', false);
                clearMigrationForm(); // Ensure form resets if the deleted item was being edited
            } catch (error) {
                console.error("Error deleting migration entry:", error);
                showMigrationMessage(`Failed to delete entry: ${error.message}`, true);
            }
        }
        
        /**
         * Resets the migration form back to the 'Add New' state.
         */
        function clearMigrationForm() {
            migrationFormEl.reset();
            document.getElementById('migrationId').value = '';
            migrationFormTitleEl.textContent = 'Add New Migration Entry';
            migrationSubmitBtn.textContent = 'Save Migration Entry';
            migrationClearBtn.style.display = 'none';
        }

        migrationClearBtn.addEventListener('click', clearMigrationForm);
        
        // =========================================================================
        // INITIALIZATION
        // =========================================================================

        /**
         * Initializes Firebase and sets up authentication.
         */
        async function initializeFirebase() {
            loadingEl.classList.remove('hidden');

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusEl.textContent = `Admin ID: ${userId} (Authenticated)`;
                        isAuthReady = true;
                        
                        // Load Leaderboard rankings for the default tab
                        loadRankings(); 
                        
                        // Note: loadMigrationStatus is called when the 'info' tab is clicked
                    } else {
                        if (initialAuthToken) {
                             await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                             await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                authStatusEl.textContent = `ERROR: Cannot connect to Firebase. ${error.message}`;
                loadingEl.classList.add('hidden');
                showMessage(`Failed to initialize application. Check console for details.`, true);
            }
        }

        window.onload = initializeFirebase;
    </script>
</body>
</html>
