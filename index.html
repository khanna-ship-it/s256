<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server 256: Command Nexus - Data Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Merriweather', serif;
            background-color: #2b3531; 
            color: #d1d5db; 
            min-height: 100vh;
            padding-bottom: 3rem;
        }

        .game-header {
            font-family: 'Inter', sans-serif;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
        }

        .game-card {
            background-color: #3f4a46; 
            border: 2px solid #58655e; 
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
            border-radius: 0.75rem;
            transition: all 0.2s ease;
        }

        /* Ranking Accents */
        .ranking-row {
            transition: background-color 0.1s;
        }
        .ranking-row:hover {
            background-color: #4a5752;
        }

        .ranking-list > .ranking-row:nth-child(odd) { background-color: #3f4a46; }
        .ranking-list > .ranking-row:nth-child(even) { background-color: #36403c; }

        .ranking-list.power > .ranking-row:nth-child(1) { border-left: 5px solid #ffcc00; }
        .ranking-list.power > .ranking-row:nth-child(1) .rank-number { color: #ffcc00; }
        .ranking-list.power > .ranking-row:nth-child(2) { border-left: 5px solid #cccccc; }
        .ranking-list.power > .ranking-row:nth-child(2) .rank-number { color: #cccccc; }
        .ranking-list.power > .ranking-row:nth-child(3) { border-left: 5px solid #cd7f32; }
        .ranking-list.power > .ranking-row:nth-child(3) .rank-number { color: #cd7f32; }

        .rank-number {
            font-size: 1.2rem;
            font-weight: 800;
            min-width: 30px;
            text-align: center;
            font-family: 'Inter', sans-serif;
        }

        .input-game {
            background-color: #2b3531;
            border: 1px solid #58655e;
            color: #e5e7eb;
            font-family: 'Inter', sans-serif;
            transition: border-color 0.3s;
        }
        .input-game:focus {
            border-color: #10b981; 
            box-shadow: 0 0 0 1px #10b981;
            outline: none;
        }
    </style>
</head>
<body>
    <div class="max-w-6xl mx-auto p-4 md:p-8">
    
        <header class="text-center mb-6">
            <h1 class="text-5xl md:text-6xl font-extrabold mb-1 game-header uppercase text-green-400">
                Server 256 Command Nexus
            </h1>
            <p class="text-xl font-light text-gray-400 game-header">
                The Land of Utopia Data Feed
            </p>
        </header>
        
        <div class="text-center mb-8">
            <div id="auth-status-bar" class="inline-flex items-center text-sm px-4 py-2 rounded-full game-card border border-green-500/50">
                <div id="auth-status-light" class="w-3 h-3 rounded-full mr-2 bg-yellow-400 animate-pulse"></div>
                <p id="auth-status" class="text-gray-300 mr-4 font-semibold">Establishing Connection...</p>
                <p id="user-id-display" class="text-xs text-gray-400 truncate">Commander ID: ANONYMOUS</p>
            </div>
        </div>

        <div id="about-section" class="game-card p-6 mb-10">
            <h2 class="text-3xl font-bold mb-4 text-green-400 border-b border-gray-600 pb-2 font-serif">
                Welcome to Server 256 Command Nexus
            </h2>
            <p class="mb-4 text-gray-300 text-lg">
                This dashboard provides a **read-only view** of the Power Rankings for Server 256, **UTOPIA**. 
                This is a peaceful server that aims to be the best of the best. Come join us to win!
                Buraya gelip bize destek verin pi√ßler!
                ÂãáÂ£´‰ª¨ÔºåÂø´Êù•Âä†ÂÖ•Êàë‰ª¨ÂêßÔºÅ
            </p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div class="p-3 bg-gray-700/30 rounded">
                    <h3 class="font-bold text-yellow-300">Server Status:</h3> Stable, mature kingdom.
                </div>
                <div class="p-3 bg-gray-700/30 rounded">
                    <h3 class="font-bold text-yellow-300">Data Source:</h3> Supabase (Real-Time Feed)
                </div>
                <div id="supabase-status-display" class="p-3 bg-gray-700/30 rounded">
                    <h3 class="font-bold text-yellow-300">Supabase Connection:</h3> <span class="text-gray-400">Checking...</span>
                </div>
            </div>
            <p class="mt-4 text-xs text-gray-500">
                The Power Ranking feed updates live from the database.
            </p>
        </div>


        <div id="ranking-section" class="game-card p-6">
            <h2 class="text-3xl font-bold mb-4 text-green-400 border-b border-gray-600 pb-2 font-serif">
                Power Ranking
            </h2>
            
            <h3 class="text-xl font-bold mb-3 text-gray-300 flex justify-between items-center">
                Live Data Feed
                <input type="text" id="search-input" placeholder="Search Commander or Alliance..." class="w-full md:w-64 p-2 rounded-lg input-game text-sm">
            </h3>
            
            <div class="grid grid-cols-12 text-xs font-semibold uppercase tracking-wider text-gray-400 p-3 border-y border-gray-600 bg-gray-700/50">
                <div class="col-span-1 flex items-center justify-center">Rank</div>
                <div class="col-span-3">Commander</div>
                <div class="col-span-2 cursor-pointer sort-header flex items-center hover:text-green-400 transition" id="sort-alliance" data-sort-key="alliance">
                    Alliance
                    <span class="sort-icon-asc ml-1 text-xs opacity-30">‚ñ≤</span>
                    <span class="sort-icon-desc text-xs opacity-30">‚ñº</span>
                </div>
                <div class="col-span-2 cursor-pointer sort-header flex items-center hover:text-green-400 transition" id="sort-ratio" data-sort-key="merits_power_ratio">
                    Ratio
                    <span class="sort-icon-asc ml-1 text-xs opacity-30">‚ñ≤</span>
                    <span class="sort-icon-desc text-xs opacity-30">‚ñº</span>
                </div>
                <div class="col-span-2 cursor-pointer sort-header flex items-center hover:text-green-400 transition" id="sort-merits" data-sort-key="total_merits">
                    merits (M)
                    <span class="sort-icon-asc ml-1 text-xs opacity-30">‚ñ≤</span>
                    <span class="sort-icon-desc text-xs opacity-30">‚ñº</span>
                </div>
                <div class="col-span-2 cursor-pointer sort-header flex items-center hover:text-green-400 transition" id="sort-power" data-sort-key="total_power">
                    Power (M)
                    <span class="sort-icon-asc ml-1 text-xs opacity-30">‚ñ≤</span>
                    <span class="sort-icon-desc text-xs opacity-30">‚ñº</span>
                </div>
            </div>

            <div id="rankings-container" class="ranking-list power divide-y divide-gray-700/70">
                <p class="p-4 text-center text-yellow-300" id="loading-message">Connecting to the databse...</p>
            </div>
        </div>

    </div>


<script type="module">

    // --- SUPABASE SETUP ---
    // Single import for the Supabase client
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const supabaseUrl = 'https://jkgtdjoqqsxzcnoioedm.supabase.co';
    // üîë ANONYMOUS PUBLIC KEY (The public key must be hardcoded for client-side use)
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprZ3Rkam9xcXN4emNub2lvZWRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MjU3NTIsImV4cCI6MjA3NzUwMTc1Mn0.a3ZtPetBm8s5GwBsB5vpZesDEt4ujhWZ6Kme0qyw_bE'; 
    
    const supabase = createClient(supabaseUrl, supabaseKey);

    // ‚ö†Ô∏è Correct Table Name and Column Selection
    const RANKING_TABLE_NAME = '256-rankings'; 
    
    // --- CORE DATA FETCHING FUNCTION ---
    async function getRankings() {
        const statusDisplay = document.querySelector('#supabase-status-display span');
        if(statusDisplay) statusDisplay.textContent = 'Loading...';

        const { data, error } = await supabase
            .from(RANKING_TABLE_NAME) 
            // Querying all required columns based on your table schema (image_99871c.png)
            .select(`rank_rank, commander_name, alliance, merits_power_ratio, total_merits, total_power`); 

        if (error) {
            console.error('SUPABASE FETCH ERROR:', error);
            const el = document.getElementById('rankings-container');
            if(el) el.innerHTML = `<p class="p-4 text-center text-red-400">CRITICAL: Supabase connection failed. ${error.message}.</p>`;
            if(statusDisplay) statusDisplay.innerHTML = '<span class="text-red-400 font-bold">CRITICAL ERROR</span>';
            return [];
        }
        
        if(statusDisplay) statusDisplay.innerHTML = '<span class="text-green-400 font-bold">CONNECTED</span>';
        return data;
    }


    // --- UTILITY VARIABLES & UI ELEMENTS (REMAINDER OF SCRIPT) ---
    const rankingsContainerEl = document.getElementById('rankings-container');
    const searchInputEl = document.getElementById('search-input');
    
    const sortAllianceEl = document.getElementById('sort-alliance');
    const sortRatioEl = document.getElementById('sort-ratio');
    const sortMeritsEl = document.getElementById('sort-merits'); 
    const sortPowerEl = document.getElementById('sort-power'); 
    
    let allRankings = []; 
    // Default sort to the Rank Rank column
    let sortState = { key: 'rank_rank', direction: 'asc' }; 


    /** Renders the list of rankings */
    const renderRankings = (rankings) => {
        
        // 1. Sort the filtered list
        const sortedRankings = [...rankings].sort((a, b) => {
            // Priority 1: Sort by current sort key
            const aVal = a[sortState.key] || 0;
            const bVal = b[sortState.key] || 0;

            if (typeof aVal === 'string' || typeof bVal === 'string') {
                if (aVal < bVal) return sortState.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortState.direction === 'asc' ? 1 : -1;
            } else {
                if (aVal < bVal) return sortState.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortState.direction === 'asc' ? 1 : -1;
            }
            
            // Secondary sort by Commander Name
            if (a.commander_name < b.commander_name) return -1;
            if (a.commander_name > b.commander_name) return 1;
            return 0; 
        });

        rankingsContainerEl.innerHTML = '';
        
        if (sortedRankings.length === 0) {
            rankingsContainerEl.innerHTML = '<p class="p-4 text-center text-gray-500">No matching commanders found in the Registry.</p>';
            return;
        }

        // 2. Update header arrows
        [sortPowerEl, sortMeritsEl, sortAllianceEl, sortRatioEl].forEach(el => {
            el.querySelectorAll('span').forEach(span => span.classList.remove('opacity-100', 'text-green-400'));
            el.querySelectorAll('span').forEach(span => span.classList.add('opacity-30'));

            if (el.dataset.sortKey === sortState.key) {
                const iconClass = sortState.direction === 'asc' ? '.sort-icon-asc' : '.sort-icon-desc';
                el.querySelector(iconClass).classList.remove('opacity-30');
                el.querySelector(iconClass).classList.add('opacity-100', 'text-green-400');
            }
        });


        // 3. Render rows
        sortedRankings.forEach((rank, index) => {
            // Use rank_rank from DB if available, otherwise use array index
            const rankNumber = rank.rank_rank || index + 1;
            
            const rankEl = document.createElement('div');
            rankEl.className = 'ranking-row grid grid-cols-12 items-center p-3 text-sm transition duration-150'; 
            
            // Helper to format numbers in Millions (M)
            const formatMillions = (value) => {
                const num = parseFloat(value) || 0;
                return (num / 1000000).toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + 'M';
            };
            
            // Helper to format Ratio
            const formatRatio = (value) => {
                const num = parseFloat(value) || 0;
                return num.toFixed(3);
            };

            let content = `
                <div class="col-span-1 flex items-center justify-center">
                    <span class="rank-number text-gray-400">${rankNumber}</span>
                </div>
                <div class="col-span-3 font-bold text-white truncate">
                    ${rank.commander_name || 'N/A'}
                </div>
                <div class="col-span-2 text-cyan-400 font-inter truncate">${rank.alliance || 'N/A'}</div>
                <div class="col-span-2 text-gray-300 font-inter">${formatRatio(rank.merits_power_ratio)}</div>
                <div class="col-span-2 text-red-400 font-inter">${formatMillions(rank.total_merits)}</div>
                <div class="col-span-2 text-yellow-300 font-inter">${formatMillions(rank.total_power)}</div>
            `;

            rankEl.innerHTML = content;
            rankingsContainerEl.appendChild(rankEl);
        });
    };

    /** Applies filter (search) and sort, then calls renderRankings */
    const applyFiltersAndSort = () => {
        const searchTerm = searchInputEl.value.toLowerCase().trim();
        
        const filteredRankings = allRankings.filter(rank => 
            (rank.commander_name?.toLowerCase().includes(searchTerm)) ||
            (rank.alliance?.toLowerCase().includes(searchTerm))
        );

        renderRankings(filteredRankings);
    };

    // --- Event Listeners for Filtering and Sorting ---
    
    // Filter Listener
    searchInputEl.addEventListener('input', applyFiltersAndSort);

    // Sort Listener Factory
    const handleSortClick = (event) => {
        const newKey = event.currentTarget.dataset.sortKey;
        
        // Set direction: descending for numbers (power/merits/ratio), ascending for alliance name
        let newDirection = (newKey === 'total_power' || newKey === 'total_merits' || newKey === 'merits_power_ratio') ? 'desc' : 'asc';


        if (sortState.key === newKey) {
            // Toggle direction if same key is clicked
            sortState.direction = sortState.direction === 'desc' ? 'asc' : 'desc';
        } else {
            // New key, set to default direction
            sortState.key = newKey;
            sortState.direction = newDirection;
        }

        applyFiltersAndSort();
    };

    sortPowerEl.addEventListener('click', handleSortClick);
    sortMeritsEl.addEventListener('click', handleSortClick);
    sortAllianceEl.addEventListener('click', handleSortClick);
    sortRatioEl.addEventListener('click', handleSortClick);


    // --- APPLICATION START ---
    window.onload = async () => {
        // 1. Update system status
        document.getElementById('auth-status').textContent = 'SECURE LINK: ACTIVE (READ-ONLY)';
        document.getElementById('auth-status-light').classList.replace('bg-yellow-400', 'bg-green-500');
        document.getElementById('auth-status-light').classList.remove('animate-pulse');
        document.getElementById('user-id-display').textContent = 'Commander ID: ANONYMOUS';

        // 2. Fetch and Render the Ranking Data
        try {
            const data = await getRankings();
            allRankings = data;
            applyFiltersAndSort(); 
            document.getElementById('loading-message')?.remove();
        } catch (e) {
            console.error("Initial load failed:", e);
            // Error message handled in getRankings
        }
    };

</script>
</body>
</html>
