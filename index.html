<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server 256 Power Rankings</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
        }
        /* Highlight Top 3 with border colors */
        .ranking-card:nth-child(2) { /* First ranking item after header row */
            border-left: 5px solid #ffcc00; /* Gold for 1st place */
            transform: scale(1.01);
            box-shadow: 0 4px 6px -1px rgba(255, 204, 0, 0.4), 0 2px 4px -2px rgba(255, 204, 0, 0.4);
        }
        .ranking-card:nth-child(3) {
            border-left: 5px solid #cccccc; /* Silver for 2nd place */
        }
        .ranking-card:nth-child(4) {
            border-left: 5px solid #cd7f32; /* Bronze for 3rd place */
        }
        .rank-number {
            font-size: 1.5rem;
            font-weight: 700;
        }
        /* Style for the top 3 rank numbers */
        .ranking-card:nth-child(2) .rank-number { color: #ffcc00; }
        .ranking-card:nth-child(3) .rank-number { color: #cccccc; }
        .ranking-card:nth-child(4) .rank-number { color: #cd7f32; }

        .header-col {
            cursor: pointer;
            transition: color 0.15s;
        }
        .header-col:hover {
            color: #4f46e5; /* Tailwind indigo-600 */
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">
    <div id="app-container" class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-white mb-2">Server Power Rankings</h1>
            <p class="text-lg text-indigo-400">Track and rank the top players.</p>
        </header>

        <!-- Notification Message Area -->
        <div id="message-box" class="hidden p-3 rounded-lg mb-6 text-sm font-medium transition-all duration-300 shadow-lg"></div>

        <!-- Submission Form -->
        <div class="bg-[#161b22] p-6 rounded-xl shadow-2xl mb-10 border border-[#21262d]">
            <h2 class="text-xl font-semibold text-white mb-4">Submit Your Rank</h2>
            <form id="ranking-form" class="space-y-4">
                <input type="text" id="player-name" required placeholder="Player Name" maxlength="30"
                       class="w-full p-3 bg-[#0d1117] border border-[#21262d] rounded-lg text-white placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500">
                <input type="number" id="player-power" required placeholder="Total Power (e.g., 125000000)" min="1"
                       class="w-full p-3 bg-[#0d1117] border border-[#21262d] rounded-lg text-white placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500">
                <input type="number" id="player-kills" required placeholder="Total Kills (e.g., 500000)" min="0"
                       class="w-full p-3 bg-[#0d1117] border border-[#21262d] rounded-lg text-white placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500">
                <button type="submit" id="submit-btn"
                        class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 disabled:opacity-50">
                    Submit Rank
                </button>
            </form>
        </div>

        <!-- Ranking List -->
        <div class="bg-[#161b22] p-6 rounded-xl shadow-2xl border border-[#21262d]">
            <h2 class="text-xl font-semibold text-white mb-4">Current Rankings</h2>

            <!-- Filter/Search -->
            <input type="text" id="search-input" placeholder="Filter by Player Name..."
                   class="w-full p-3 bg-[#0d1117] border border-[#21262d] rounded-lg text-white placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500 mb-4">

            <!-- Ranking Header Row -->
            <div id="ranking-header" class="grid grid-cols-6 gap-2 text-sm font-medium text-gray-400 border-b border-[#21262d] pb-2 mb-2">
                <div class="col-span-1 p-2 text-left">RANK</div>
                <div class="col-span-2 p-2 text-left">PLAYER (ID)</div>
                <div class="col-span-2 p-2 text-right header-col" data-sort-key="power" id="sort-power">
                    POWER <span id="sort-power-icon" class="ml-1">â†“</span>
                </div>
                <div class="col-span-1 p-2 text-right header-col" data-sort-key="kills" id="sort-kills">
                    KILLS <span id="sort-kills-icon" class="ml-1"></span>
                </div>
            </div>

            <!-- Ranking List Container -->
            <div id="rankings-list" class="space-y-2">
                <!-- Rankings will be inserted here by JavaScript -->
                <p id="loading-indicator" class="text-center text-gray-500 p-8">Loading rankings...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"; // Import for Firebase Analytics

        // --- Global Variables ---
        // We keep appId and initialAuthToken for environment-specific authentication/storage paths.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Your web app's Firebase configuration (now hardcoded to bypass config missing error)
        const firebaseConfig = {
            apiKey: "AIzaSyDPBsLGnZSy9gl0J-Toy97sx04sbMliN1A",
            authDomain: "aoem-s256.firebaseapp.com",
            projectId: "aoem-s256",
            storageBucket: "aoem-s256.firebasestorage.app",
            messagingSenderId: "841512392095",
            appId: "1:841512392095:web:84df8ffedacb97352859aa",
            measurementId: "G-N6GB8LBHWJ"
        };

        let db;
        let auth;
        let userId = null;

        // --- Utility Functions ---

        /**
         * Displays a notification message to the user.
         * @param {string} message The message to display.
         * @param {boolean} isError True if the message is an error.
         */
        const showMessage = (message, isError) => {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.classList.remove('hidden', 'bg-red-800', 'text-red-200', 'bg-green-800', 'text-green-200');

            if (isError) {
                box.classList.add('bg-red-800', 'text-red-200');
            } else {
                box.classList.add('bg-green-800', 'text-green-200');
            }

            // Hide after 5 seconds
            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        };

        // --- Core Application State & Logic ---

        let rankings = [];
        const sortState = { key: 'power', direction: 'desc' }; // Default sort is by power, descending
        let searchFilter = '';

        /**
         * Renders the current list of filtered and sorted rankings to the DOM.
         * @param {Array} currentRankings The list of rankings to display.
         */
        const renderRankings = (currentRankings) => {
            const listEl = document.getElementById('rankings-list');
            listEl.innerHTML = ''; // Clear existing content

            if (currentRankings.length === 0) {
                listEl.innerHTML = `<p class="text-center text-gray-500 p-4">No rankings found.</p>`;
                return;
            }

            currentRankings.forEach((data, index) => {
                const rank = index + 1;
                const powerFormatted = data.power.toLocaleString();
                const killsFormatted = data.kills.toLocaleString();
                const userIdDisplay = data.userId.substring(0, 8);

                const cardHtml = `
                    <div class="ranking-card grid grid-cols-6 gap-2 bg-[#0d1117] p-3 rounded-lg items-center border border-[#21262d] transition duration-100 ease-in-out">
                        <!-- Rank Number -->
                        <div class="col-span-1 text-center text-indigo-400 rank-number">${rank}</div>

                        <!-- Player Name/ID -->
                        <div class="col-span-2 text-left text-white">
                            <div class="font-semibold">${data.name}</div>
                            <div class="text-xs text-gray-500 truncate" title="User ID: ${data.userId}">ID: ${userIdDisplay}...</div>
                        </div>

                        <!-- Power -->
                        <div class="col-span-2 text-right text-yellow-400 font-mono">${powerFormatted}</div>

                        <!-- Kills -->
                        <div class="col-span-1 text-right text-red-400 font-mono">${killsFormatted}</div>
                    </div>
                `;
                listEl.insertAdjacentHTML('beforeend', cardHtml);
            });
        };

        /**
         * Filters and sorts the global rankings list and triggers a re-render.
         */
        const applyFiltersAndSort = () => {
            let filtered = rankings.filter(rank =>
                rank.name.toLowerCase().includes(searchFilter.toLowerCase())
            );

            // Sort logic
            filtered.sort((a, b) => {
                const aVal = a[sortState.key];
                const bVal = b[sortState.key];

                if (aVal < bVal) return sortState.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortState.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Update sort icons
            document.querySelectorAll('[data-sort-key]').forEach(el => {
                const key = el.dataset.sortKey;
                const iconEl = document.getElementById(`sort-${key}-icon`);
                iconEl.textContent = ''; // Clear all icons first
            });

            const currentIconEl = document.getElementById(`sort-${sortState.key}-icon`);
            if (currentIconEl) {
                currentIconEl.textContent = sortState.direction === 'desc' ? 'â†“' : 'â†‘';
            }

            renderRankings(filtered);
        };

        /**
         * Sets up the real-time Firestore listener for the rankings collection.
         */
        const setupRankingListener = () => {
            if (!db) return;

            const collectionPath = `/artifacts/${appId}/public/data/rankings`;
            const rankingsCollection = collection(db, collectionPath);
            const q = query(rankingsCollection);

            // Real-time listener
            onSnapshot(q, (snapshot) => {
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) loadingIndicator.remove(); // Remove loading text once data arrives

                const newRankings = [];
                snapshot.forEach((doc) => {
                    newRankings.push(doc.data());
                });

                rankings = newRankings; // Update global list
                applyFiltersAndSort(); // Re-filter and re-sort
            }, (error) => {
                console.error("Error setting up snapshot listener:", error);
                showMessage(`Failed to load rankings: ${error.message}`, true);
            });
        };

        /**
         * Initializes Firebase App, Auth, Firestore, and Analytics.
         */
        const initializeFirebase = async () => {
            try {
                // Initialize Firebase App
                const app = initializeApp(firebaseConfig);
                
                // Initialize Analytics
                const analytics = getAnalytics(app); 
                
                // Initialize Firestore and Auth
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for auth state to be confirmed
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("User signed in with ID:", userId);
                        } else {
                            // This should not happen if signInAnonymously succeeded, but for safety
                            userId = crypto.randomUUID();
                            console.log("User is not signed in, using random ID:", userId);
                        }
                        unsubscribe();
                        resolve();
                    });
                });

                // Setup the real-time listener after successful initialization
                setupRankingListener();

            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                showMessage(`App setup failed. Check console for details. Error: ${error.message}`, true);
            }
        };

        // --- Event Handlers ---

        const formEl = document.getElementById('ranking-form');
        const submitBtn = document.getElementById('submit-btn');
        const searchInputEl = document.getElementById('search-input');
        const sortPowerEl = document.getElementById('sort-power');
        const sortKillsEl = document.getElementById('sort-kills');

        // Form Submission Handler
        formEl.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!db || !userId) {
                showMessage("Database or User ID is not ready. Please wait.", true);
                return;
            }

            const name = document.getElementById('player-name').value.trim();
            const power = parseInt(document.getElementById('player-power').value, 10);
            const kills = parseInt(document.getElementById('player-kills').value, 10);

            if (!name || isNaN(power) || isNaN(kills)) {
                showMessage("Please ensure all fields are filled correctly.", true);
                return;
            }

            submitBtn.textContent = "Submitting...";
            submitBtn.disabled = true;

            // Use the user's ID as the document ID for 'upsert' functionality
            // Private data storage path: /artifacts/{appId}/users/{userId}/rankings/{documentId}
            const documentId = userId;
            const rankDocRef = doc(db, `/artifacts/${appId}/users/${userId}/rankings`, documentId);

            const newRanking = {
                name: name,
                power: power,
                kills: kills,
                userId: userId,
                timestamp: Date.now()
            };

            try {
                // Save the data to the user's private collection
                await setDoc(rankDocRef, newRanking);

                // Also save a copy to the public collection (using the same document ID for simplicity)
                // Public data storage path: /artifacts/${appId}/public/data/rankings/{documentId}
                const publicDocRef = doc(db, `/artifacts/${appId}/public/data/rankings`, documentId);
                await setDoc(publicDocRef, newRanking);


                showMessage(`Ranking for ${name} submitted/updated successfully!`, false);
                formEl.reset();
            } catch (error) {
                console.error("Error submitting ranking:", error);
                showMessage(`Failed to submit ranking: ${error.message}`, true);
            } finally {
                submitBtn.textContent = "Submit Rank";
                submitBtn.disabled = false;
            }
        });

        // --- Event Listeners for Filtering and Sorting ---\

        // Filter Listener
        searchInputEl.addEventListener('input', (event) => {
            searchFilter = event.target.value.trim();
            applyFiltersAndSort();
        });

        // Sort Listener Factory
        const handleSortClick = (event) => {
            const newKey = event.currentTarget.dataset.sortKey;

            if (sortState.key === newKey) {
                // Toggle direction if same key is clicked
                sortState.direction = sortState.direction === 'desc' ? 'asc' : 'desc';
            } else {
                // New key, reset to descending (standard for rankings)
                sortState.key = newKey;
                sortState.direction = 'desc';
            }

            applyFiltersAndSort();
        };

        sortPowerEl.addEventListener('click', handleSortClick);
        sortKillsEl.addEventListener('click', handleSortClick);


        // Start the application
        window.onload = initializeFirebase;
    </script>
    <!-- Vercel Web Analytics Script -->
    <script src="/_vercel/insights/script.js"></script>
</body>
</html>
