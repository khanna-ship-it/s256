<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APEX RANKINGS | Server 256 Dominance</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0d12; /* Deep space dark */
            color: #e5e7eb; /* Light text */
        }
        .ranking-card {
            transition: all 0.2s;
            border-left: 5px solid transparent;
        }
        
        /* Gold/Apex for 1st place */
        .ranking-card:nth-child(2) { 
            border-left-color: #ffd700; 
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            transform: scale(1.02);
            background-color: #1a1e28;
        }
        /* Silver for 2nd place */
        .ranking-card:nth-child(3) {
            border-left-color: #cccccc; 
            background-color: #1a1e28;
        }
        /* Bronze for 3rd place */
        .ranking-card:nth-child(4) {
            border-left-color: #cd7f32; 
            background-color: #1a1e28;
        }
        
        /* Style for the rank number */
        .rank-number {
            font-size: 1.5rem;
            font-weight: 800;
        }
        .ranking-card:nth-child(2) .rank-number { color: #ffd700; }
        .ranking-card:nth-child(3) .rank-number { color: #cccccc; }
        .ranking-card:nth-child(4) .rank-number { color: #cd7f32; }

        .btn-primary {
            background-image: linear-gradient(to right, #ef4444, #dc2626);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        /* Sorting arrows */
        .sort-icon {
            opacity: 0.3;
        }
        .sorted-asc .sort-icon-asc {
            opacity: 1;
            color: #3b82f6; /* Blue for active sort */
        }
        .sorted-desc .sort-icon-desc {
            opacity: 1;
            color: #3b82f6;
        }
        .sort-header:hover .sort-icon {
            opacity: 0.7;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-4xl mx-auto p-4 md:p-8">

        <!-- Header Section: Aggressive and Exclusive -->
        <header class="text-center mb-10">
            <h1 class="text-5xl md:text-6xl font-extrabold mb-2 uppercase text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-red-600 tracking-wider">
                SERVER 256
            </h1>
            <p class="text-xl md:text-2xl font-semibold text-gray-300 mb-6">
                The APEX of Power. The Elite of Warfare.
            </p>

            <!-- Call to Action for Krakens & Whales -->
            <div class="bg-gray-900 border border-red-700/50 p-6 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-bold text-red-400 mb-3">Krakens & Whales: Your New Home Awaits.</h2>
                <p class="text-gray-400 mb-6 max-w-2xl mx-auto">
                    If you seek true **Dominance** and the highest level of warfare, Server 256 is the only battlefield. Join the elite.
                </p>
                <!-- NOTE: Replace '#' with your actual Discord/Contact link -->
                <a href="#" target="_blank" class="inline-block px-12 py-3 text-lg font-bold text-white uppercase rounded-lg btn-primary hover:scale-[1.03] transition duration-300 transform">
                    Contact the 256 Command
                </a>
            </div>
        </header>

        <!-- Current User Info (for tracking/reference) -->
        <div class="text-center text-sm mb-6 p-3 bg-gray-800/50 rounded-lg">
            <p id="auth-status" class="text-gray-400">Awaiting Authentication...</p>
            <p id="user-id-display" class="text-xs text-gray-500 mt-1 truncate">User ID: </p>
        </div>


        <!-- RANK Submission Form -->
        <section class="mb-10 p-6 bg-gray-800 rounded-xl shadow-lg border border-gray-700">
            <h2 class="text-2xl font-bold mb-4 text-red-300">Submit Your Dominance Profile</h2>
            <form id="ranking-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="name" placeholder="Commander Name" required class="p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-red-500 focus:border-red-500">
                <input type="number" id="power" placeholder="Total Power (in Millions)" required class="p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-red-500 focus:border-red-500">
                <!-- UPDATED: KILLS TO MERITS -->
                <input type="number" id="merits" placeholder="Total Merits (in Millions)" required class="p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-red-500 focus:border-red-500">
                <button type="submit" id="submit-btn" class="md:col-span-3 p-3 font-bold text-white rounded-lg transition duration-200 btn-primary" disabled>
                    Submit Rank
                </button>
            </form>
            <div id="message-box" class="mt-4 hidden p-3 rounded-lg text-center" role="alert"></div>
        </section>

        <!-- RANKINGS LIST SECTION -->
        <section class="bg-gray-900 rounded-xl shadow-2xl overflow-hidden border border-gray-700">
            <!-- Updated Heading -->
            <h2 class="text-3xl font-bold p-6 border-b border-gray-700 text-yellow-400/90">
                Current Server 256 Rankings
            </h2>
            
            <!-- Filter -->
            <div class="p-4 border-b border-gray-700">
                <input type="text" id="search-input" placeholder="Filter by Commander Name..." class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-red-500 focus:border-red-500">
            </div>

            <!-- Ranking Header Row (Sortable) -->
            <div class="grid grid-cols-12 text-xs font-semibold uppercase tracking-wider text-gray-400 p-4 border-b border-gray-700">
                <div class="col-span-1">#</div>
                <div class="col-span-4">Commander Name</div>
                <div class="col-span-3 cursor-pointer sort-header" id="sort-power" data-sort-key="power">
                    Power (M)
                    <span class="sort-icon-asc sort-icon">▲</span>
                    <span class="sort-icon-desc sort-icon">▼</span>
                </div>
                <!-- UPDATED: KILLS TO MERITS -->
                <div class="col-span-3 cursor-pointer sort-header" id="sort-merits" data-sort-key="merits">
                    Merits (M)
                    <span class="sort-icon-asc sort-icon">▲</span>
                    <span class="sort-icon-desc sort-icon">▼</span>
                </div>
                <div class="col-span-1 text-right">Edit</div>
            </div>

            <!-- Ranking Data Container -->
            <div id="rankings-container" class="divide-y divide-gray-800">
                <!-- Rankings will be injected here by the JavaScript code via renderRankings() -->
                <p class="p-4 text-center text-gray-500" id="loading-message">Loading the Apex Rankings...</p>
            </div>
        </section>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // --- FIREBASE SETUP ---
        setLogLevel('Debug');
        let db;
        let auth;
        let userId = null;
        // NEW: Store the ID of the user who launched the app (the administrator)
        let adminUserId = null; 

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // CRITICAL UPDATE: Safely parse config and ensure it's not empty before proceeding
        let firebaseConfig = {};
        try {
            const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            firebaseConfig = JSON.parse(configString);
        } catch (e) {
            console.error("Failed to parse Firebase configuration string:", e);
        }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Firestore Collection Path
        const COLLECTION_PATH = `artifacts/${appId}/public/data/server256_rankings`;

        // UI Elements
        const formEl = document.getElementById('ranking-form');
        const nameInputEl = document.getElementById('name');
        const powerInputEl = document.getElementById('power');
        const meritsInputEl = document.getElementById('merits');
        const submitBtn = document.getElementById('submit-btn');
        const rankingsContainerEl = document.getElementById('rankings-container');
        const searchInputEl = document.getElementById('search-input');
        const messageBoxEl = document.getElementById('message-box');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const authStatusEl = document.getElementById('auth-status');
        const sortPowerEl = document.getElementById('sort-power');
        const sortMeritsEl = document.getElementById('sort-merits'); 
        
        let allRankings = []; // Master list of all rankings
        let sortState = { key: 'power', direction: 'desc' }; // Default sort
        let isAuthReady = false;

        // --- Utility Functions ---

        /** Shows a temporary status message */
        const showMessage = (message, isError) => {
            messageBoxEl.textContent = message;
            messageBoxEl.classList.remove('hidden', 'bg-red-900', 'bg-green-900', 'text-red-300', 'text-green-300');
            messageBoxEl.classList.add(isError ? 'bg-red-900' : 'bg-green-900', isError ? 'text-red-300' : 'text-green-300');
            setTimeout(() => {
                messageBoxEl.classList.add('hidden');
            }, 5000);
        };

        /** Deletes a ranking document */
        const deleteRanking = async (docData) => {
            // SECURITY CHECK: Only allow the admin to delete any ranking
            if (!db || userId !== adminUserId) {
                showMessage("ERROR: Only the administrator can delete rankings.", true);
                return;
            }

            const confirmDelete = () => {
                // Simple custom confirmation UI, since alert() is forbidden
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-80">
                        <p class="text-white mb-4">Are you sure you want to delete this ranking?</p>
                        <div class="flex justify-end space-x-3">
                            <button id="cancel-delete" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-500 transition">Cancel</button>
                            <button id="confirm-delete" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">Delete</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('confirm-delete').onclick = async () => {
                    modal.remove();
                    try {
                        const rankDocRef = doc(db, COLLECTION_PATH, docData.id);
                        await deleteDoc(rankDocRef);
                        showMessage("Ranking deleted successfully.", false);
                    } catch (error) {
                        console.error("Error deleting ranking:", error);
                        showMessage("Failed to delete ranking.", true);
                    }
                };

                document.getElementById('cancel-delete').onclick = () => {
                    modal.remove();
                };
            };
            
            confirmDelete();
        };

        /** Renders the list of rankings */
        const renderRankings = (rankings) => {
            const isAdmin = userId && userId === adminUserId; // Check if the current user is the admin

            // Sort the filtered list (defaulting to power descending)
            const sortedRankings = [...rankings].sort((a, b) => {
                const aVal = a[sortState.key];
                const bVal = b[sortState.key];

                if (aVal < bVal) return sortState.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortState.direction === 'asc' ? 1 : -1;
                return 0; // Fallback to maintain original order if values are equal
            });

            rankingsContainerEl.innerHTML = '';
            
            if (sortedRankings.length === 0) {
                rankingsContainerEl.innerHTML = '<p class="p-4 text-center text-gray-500">No elite commanders match the current filter.</p>';
                return;
            }

            // Update header arrows to show current sort state
            [sortPowerEl, sortMeritsEl].forEach(el => {
                el.classList.remove('sorted-asc', 'sorted-desc');
                if (el.dataset.sortKey === sortState.key) {
                    el.classList.add(sortState.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            });


            sortedRankings.forEach((rank, index) => {
                const rankNumber = index + 1;
                
                const rankEl = document.createElement('div');
                rankEl.className = 'ranking-card grid grid-cols-12 items-center p-4 hover:bg-gray-700/50 transition duration-150';
                
                // Content for the row
                let content = `
                    <div class="col-span-1">
                        <span class="rank-number">${rankNumber}</span>
                    </div>
                    <div class="col-span-4 font-bold text-lg text-white truncate">
                        ${rank.name}
                    </div>
                    <div class="col-span-3 text-red-400 font-semibold">
                        ${(rank.power / 1000000).toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 })}M
                    </div>
                    <!-- UPDATED: Display merits instead of kills -->
                    <div class="col-span-3 text-red-400 font-semibold">
                        ${(rank.merits / 1000000).toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 })}M
                    </div>
                    <div class="col-span-1 flex justify-end space-x-2">
                        ${isAdmin ? `
                            <button data-id="${rank.id}" class="edit-btn text-blue-400 hover:text-blue-300 transition duration-150" title="Edit Ranking">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-1.63 2.828l-7.388 7.388a1 1 0 00-.288.583v3.465a1 1 0 001 1h3.465a1 1 0 00.583-.288l7.388-7.388-2.828-2.828z" />
                                </svg>
                            </button>
                            <button data-id="${rank.id}" class="delete-btn text-red-400 hover:text-red-300 transition duration-150" title="Delete Ranking">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 100 2v6a1 1 0 100-2V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        ` : ''}
                    </div>
                `;

                rankEl.innerHTML = content;
                rankingsContainerEl.appendChild(rankEl);
            });
            
            // Re-attach listeners for dynamically generated buttons (only visible to admin)
            if (isAdmin) {
                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        const rankToEdit = allRankings.find(r => r.id === id);
                        if (rankToEdit) {
                            nameInputEl.value = rankToEdit.name;
                            powerInputEl.value = rankToEdit.power / 1000000;
                            // UPDATED: Populate merits field
                            meritsInputEl.value = rankToEdit.merits / 1000000;
                            formEl.dataset.editId = id; // Store ID for update
                            submitBtn.textContent = "Update Rank";
                            showMessage(`Editing rank for ${rankToEdit.name}.`, false);
                        }
                    });
                });

                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        // ownerId is not needed here as we use the admin check in deleteRanking
                        deleteRanking({ id }); 
                    });
                });
            }
        };

        /** Applies filter (search) and sort, then calls renderRankings */
        const applyFiltersAndSort = () => {
            const searchTerm = searchInputEl.value.toLowerCase().trim();
            
            const filteredRankings = allRankings.filter(rank => 
                rank.name.toLowerCase().includes(searchTerm)
            );

            renderRankings(filteredRankings);
        };


        // --- FIREBASE INITIALIZATION AND REAL-TIME LISTENER ---

        const initializeFirebase = async () => {
            
            // CRITICAL CHECK: Ensure we have config data before trying to initialize Firebase
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                authStatusEl.textContent = 'ERROR: Firebase configuration is missing. Cannot connect to database.';
                userIdDisplayEl.textContent = 'User ID: N/A';
                submitBtn.disabled = true;
                rankingsContainerEl.innerHTML = '<p class="p-4 text-center text-red-400">Database connection failed. Configuration missing.</p>';
                console.error('Firebase Error: Configuration object is empty or missing required fields.');
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                submitBtn.disabled = true;

                // Sign in with custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for auth state to resolve
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // NEW: Set the admin ID to the first authenticated user (the user running this app)
                        if (!adminUserId) {
                            adminUserId = user.uid;
                        }
                        
                        userIdDisplayEl.textContent = `User ID: ${userId} ${userId === adminUserId ? '(ADMIN)' : ''}`;
                        authStatusEl.textContent = 'Authenticated (Ready to Submit)';
                        isAuthReady = true;
                        submitBtn.disabled = false;
                        
                        // Setup the real-time listener ONLY after auth is ready
                        setupRealtimeListener();

                    } else {
                        userId = null;
                        userIdDisplayEl.textContent = 'User ID: N/A';
                        authStatusEl.textContent = 'Unauthenticated (Limited features)';
                        isAuthReady = true; // Still ready, but anonymous
                        submitBtn.disabled = false;
                        
                        // Setup the real-time listener for anonymous users too
                        setupRealtimeListener();
                    }
                });

            } catch (error) {
                // Catch any other Firebase initialization errors
                console.error("Firebase initialization failed:", error);
                authStatusEl.textContent = `Error: ${error.message}`;
                showMessage(`Firebase init failed: ${error.message}`, true);
            }
        };


        const setupRealtimeListener = () => {
             if (!db || !isAuthReady) return;

             const rankingsCollectionRef = collection(db, COLLECTION_PATH);
             // Note: We avoid orderBy in the query and rely on client-side sorting (renderRankings)
             const q = query(rankingsCollectionRef);

             onSnapshot(q, (snapshot) => {
                 allRankings = snapshot.docs.map(doc => ({
                     id: doc.id,
                     ...doc.data()
                 }));
                 
                 // Apply filters and sort to the new data
                 applyFiltersAndSort();
                 document.getElementById('loading-message')?.remove();

             }, (error) => {
                 console.error("Error listening to collection:", error);
                 rankingsContainerEl.innerHTML = '<p class="p-4 text-center text-red-400">Error fetching rankings.</p>';
             });
        };


        // --- FORM SUBMISSION LOGIC ---
        formEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || !userId) {
                showMessage("Authentication not ready. Please wait.", true);
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = "Submitting...";

            const name = nameInputEl.value.trim();
            const powerMillions = parseFloat(powerInputEl.value);
            const meritsMillions = parseFloat(meritsInputEl.value);

            if (isNaN(powerMillions) || isNaN(meritsMillions) || powerMillions <= 0 || meritsMillions < 0) {
                 showMessage("Please enter valid, positive numbers for Power and Merits.", true);
                 submitBtn.textContent = "Submit Rank";
                 submitBtn.disabled = false;
                 return;
            }

            const power = Math.round(powerMillions * 1000000); // Store as absolute number (integer)
            const merits = Math.round(meritsMillions * 1000000); // Store merits
            const editId = formEl.dataset.editId;

            // Check if this is an update attempt and restrict it to admin
            if (editId && userId !== adminUserId) {
                showMessage("ERROR: Only the administrator can update existing rankings.", true);
                submitBtn.textContent = "Submit Rank";
                submitBtn.disabled = false;
                return;
            }


            const newRanking = {
                name,
                power,
                merits,
                // If this is a new submission, assign ownerId. If it's an admin update, we keep the original ownerId, but for this specific application, we'll set it to the current user's ID.
                ownerId: userId, 
                updatedAt: new Date().toISOString(),
            };

            const rankDocRef = editId ? doc(db, COLLECTION_PATH, editId) : doc(collection(db, COLLECTION_PATH));
            
            try {
                await setDoc(rankDocRef, newRanking, { merge: true });
                showMessage(`Ranking for ${name} ${editId ? 'updated' : 'submitted'} successfully!`, false);
                formEl.reset();
                delete formEl.dataset.editId; // Clear edit state
                submitBtn.textContent = "Submit Rank";
            } catch (error) {
                console.error("Error submitting ranking:", error);
                showMessage(`Failed to submit ranking: ${error.message}`, true);
            } finally {
                submitBtn.disabled = false;
            }
        });

        // --- Event Listeners for Filtering and Sorting ---
        
        // Filter Listener
        searchInputEl.addEventListener('input', applyFiltersAndSort);

        // Sort Listener Factory
        const handleSortClick = (event) => {
            const newKey = event.currentTarget.dataset.sortKey;

            if (sortState.key === newKey) {
                // Toggle direction if same key is clicked
                sortState.direction = sortState.direction === 'desc' ? 'asc' : 'desc';
            } else {
                // New key, reset to descending (standard for rankings)
                sortState.key = newKey;
                sortState.direction = 'desc';
            }

            applyFiltersAndSort();
        };

        sortPowerEl.addEventListener('click', handleSortClick);
        sortMeritsEl.addEventListener('click', handleSortClick);


        // Start the application
        window.onload = initializeFirebase;
    </script>
</body>
</html>
